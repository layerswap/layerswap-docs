---
mode: "custom"
---

import { depositWidgetConfig } from "/snippets/depositWidget.config.jsx"

<script suppressHydrationWarning>
  {`(() => {
    const REMOTE_WIDGET_URL = ${JSON.stringify((depositWidgetConfig?.productionUrl || '').trim())};
    const LOCAL_WIDGET_URL = '/deposit-widget/index.html';
    const EMBEDDED_LOCAL_WIDGET_ENV_FLAG = ${JSON.stringify(
      (() => {
        if (typeof process !== 'undefined' && process && process.env) {
          const raw =
            process.env.NEXT_PUBLIC_DEPOSIT_WIDGET_USE_LOCAL ??
            process.env.DEPOSIT_WIDGET_USE_LOCAL ??
            '';
          return typeof raw === 'string' ? raw.trim() : '';
        }
        return '';
      })()
    )};

    const resolveLocalEnvFlag = () => {
      if (typeof window !== 'undefined') {
        const manualFlag = window.__DEPOSIT_WIDGET_USE_LOCAL__;
        if (typeof manualFlag === 'string' && manualFlag.trim()) {
          return manualFlag.trim();
        }
      }
      return EMBEDDED_LOCAL_WIDGET_ENV_FLAG;
    };

    const LOCAL_WIDGET_ENV_FLAG = resolveLocalEnvFlag();

    if (typeof window !== 'undefined' && LOCAL_WIDGET_ENV_FLAG) {
      window.__DEPOSIT_WIDGET_USE_LOCAL__ = LOCAL_WIDGET_ENV_FLAG;
    }

    const shouldForceLocalWidget = () => {
      if (!LOCAL_WIDGET_ENV_FLAG) return false;
      const normalized = LOCAL_WIDGET_ENV_FLAG.toLowerCase();
      return normalized === '1' || normalized === 'true' || normalized === 'yes' || normalized === 'local';
    };

    const resolveWidgetSrc = () => {
      if (shouldForceLocalWidget()) {
        return LOCAL_WIDGET_URL;
      }
      if (REMOTE_WIDGET_URL) {
        return REMOTE_WIDGET_URL;
      }
      return LOCAL_WIDGET_URL;
    };

    const updateWidgetSrc = (iframe) => {
      if (!iframe) return;
      const nextSrc = resolveWidgetSrc();
      if (!nextSrc) return;
      const current = iframe.getAttribute('src') || '';
      if (current !== nextSrc) {
        iframe.setAttribute('src', nextSrc);
      }
    };

    const THEME_MESSAGE_TYPE = 'DEPOSIT_WIDGET_THEME';
    const THEME_REQUEST_MESSAGE_TYPE = 'DEPOSIT_WIDGET_THEME_REQUEST';
    const THEME_ATTRS = ['data-theme', 'data-mode', 'data-color-mode', 'data-color-theme', 'data-appearance', 'data-color-scheme'];
    const OBSERVED_ATTRS = ['class', ...THEME_ATTRS];
    const FALLBACK_LOCAL_STORAGE_KEYS = ['mintlify', 'appearance', 'color', 'theme', 'mode'];
    let lastSentTheme;
    let pollIntervalId;

    const detectThemeFromValue = (value) => {
      if (!value || typeof value !== 'string') return undefined;
      const lowered = value.toLowerCase();
      if (lowered.includes('dark')) return 'dark';
      if (lowered.includes('light')) return 'light';
      if (lowered === 'system') {
        return window.matchMedia?.('(prefers-color-scheme: dark)')?.matches ? 'dark' : 'light';
      }
      return undefined;
    };

    const inferThemeFromElement = (element) => {
      if (!element) return undefined;

      for (const attr of THEME_ATTRS) {
        const value = element.getAttribute?.(attr);
        const theme = detectThemeFromValue(value);
        if (theme) return theme;
      }

      if (element.dataset) {
        for (const value of Object.values(element.dataset)) {
          const theme = detectThemeFromValue(value);
          if (theme) return theme;
        }
      }

      if (element.classList) {
        for (const token of element.classList) {
          const theme = detectThemeFromValue(token);
          if (theme) return theme;
        }
      }

      try {
        const style = element.ownerDocument?.defaultView?.getComputedStyle(element);
        const colorScheme = style?.getPropertyValue?.('color-scheme');
        const themeFromScheme = detectThemeFromValue(colorScheme);
        if (themeFromScheme) return themeFromScheme;

        const background = style?.getPropertyValue?.('background-color');
        if (background) {
          const numbers = background.match(/\d+\.?\d*/g)?.map(Number);
          if (numbers && numbers.length >= 3) {
            const [r, g, b] = numbers;
            const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            if (luminance < 90) return 'dark';
            if (luminance > 200) return 'light';
          }
        }
      } catch (error) {
        // Ignore computed style errors
      }

      return undefined;
    };

    const collectCandidateElements = () => {
      const elements = new Set([document.documentElement, document.body]);
      const selectors = ['[data-theme]', '[data-mode]', '[data-color-mode]', '[data-color-theme]', '[data-color-scheme]'];
      selectors.forEach((selector) => {
        document.querySelectorAll(selector).forEach((el) => elements.add(el));
      });
      return Array.from(elements).filter(Boolean);
    };

    const resolveTheme = () => {
      const candidates = collectCandidateElements();
      for (const element of candidates) {
        const theme = inferThemeFromElement(element);
        if (theme === 'dark' || theme === 'light') {
          return theme;
        }
      }

      try {
        for (let i = 0; i < localStorage.length; i += 1) {
          const key = localStorage.key(i);
          if (!key) continue;
          if (!FALLBACK_LOCAL_STORAGE_KEYS.some((needle) => key.toLowerCase().includes(needle))) continue;
          const theme = detectThemeFromValue(localStorage.getItem(key) || '');
          if (theme) return theme;
        }
      } catch (error) {
        // Ignore storage errors (e.g. disabled storage)
      }

      return window.matchMedia?.('(prefers-color-scheme: dark)')?.matches ? 'dark' : 'light';
    };

    const sendThemeToIframe = (force = false) => {
      const iframe = document.querySelector('iframe[data-deposit-widget]');
      if (!iframe || !iframe.contentWindow) return;
      const theme = resolveTheme();
      if (!theme) return;
      if (!force && theme === lastSentTheme) return;
      lastSentTheme = theme;
      iframe.contentWindow.postMessage({ type: THEME_MESSAGE_TYPE, theme }, '*');
    };

    const setupThemeSync = () => {
      const iframe = document.querySelector('iframe[data-deposit-widget]');
      if (iframe) {
        updateWidgetSrc(iframe);
        iframe.addEventListener('load', () => sendThemeToIframe(true), { once: true });
      }

      const observer = new MutationObserver(() => sendThemeToIframe());
      observer.observe(document.documentElement, {
        attributes: true,
        subtree: true,
        attributeFilter: OBSERVED_ATTRS,
      });
      observer.observe(document.body, {
        attributes: true,
        subtree: true,
        attributeFilter: OBSERVED_ATTRS,
      });

      window.addEventListener('message', (event) => {
        if (event?.data?.type === THEME_REQUEST_MESSAGE_TYPE) {
          sendThemeToIframe(true);
        }
      });

      window.addEventListener('storage', (event) => {
        if (!event?.key) return;
        if (FALLBACK_LOCAL_STORAGE_KEYS.some((needle) => event.key.toLowerCase().includes(needle))) {
          sendThemeToIframe();
        }
      });

      pollIntervalId = window.setInterval(() => sendThemeToIframe(), 1500);

      sendThemeToIframe(true);

      window.addEventListener('pagehide', () => {
        observer.disconnect();
        if (pollIntervalId) {
          window.clearInterval(pollIntervalId);
          pollIntervalId = null;
        }
      }, { once: true });
    };

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setupThemeSync();
    } else {
      window.addEventListener('DOMContentLoaded', setupThemeSync, { once: true });
    }
  })();`}
</script>

<iframe
  src="/deposit-widget/index.html"
  title="Layerswap Deposit API Tutorial"
  data-deposit-widget
  style={{
    width: '100%',
    minHeight: '90vh',
    border: 'none',
    display: 'block'
  }}
/>
